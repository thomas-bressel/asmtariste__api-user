name: Deploy to VPS
on:
  push:
    branches: [ main ]
 
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npx jest

  deploy:
    needs: test
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."
                   
          # VÃ©rifier si le dossier existe
          if [ ! -d "$HOME/asmtariste/asmtariste__api-user" ]; then
            echo "âŒ Directory $HOME/asmtariste/asmtariste__api-user does not exist!"
            exit 1
          fi
          
          # Aller dans le dossier du projet
          cd ~/asmtariste/asmtariste__api-user
          echo "ğŸ“ Now in: $(pwd)"
          
          # Forcer la mise Ã  jour (Ã©craser les modifications locales)
          # echo "ğŸ“¥ Resetting local changes and pulling..."
          # git reset --hard HEAD
          # git clean -fd
          git pull origin main
          
          
          # VÃ©rifier docker-compose dans le parent
          echo "ğŸ³ Checking docker-compose file in parent directory:"
          ls -la ../docker-compose.yml || echo "âš ï¸ docker-compose.yml not found in parent!"
          
          # ArrÃªter les containers existants (depuis le parent)
          echo "ğŸ›‘ Stopping containers..."
          cd .. && docker compose down || echo "âš ï¸ No containers to stop"
          
          # Rebuild et redÃ©marrer (depuis le parent)
          echo "ğŸ”¨ Building and starting containers..."
          docker compose up -d --build
          
          # VÃ©rifier que tout fonctionne
          echo "âœ… Checking containers status..."
          docker compose ps
          
          echo "ğŸ‰ Deployment completed!"